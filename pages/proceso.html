<!-- proceso.html actualizado con parseInt para filtrar por c_proceso correctamente -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebLiqui - Detalle del Proceso</title>
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="topbar">
      <div class="logo">WebLiqui</div>
      <div class="user">
        <span>Martín Rodríguez</span>
        <div class="avatar">M</div>
      </div>
    </div>

    <div class="main-container">
      <div class="sidebar">
        <h3>Menú</h3>
        <nav>
          <a href="./procesos.html">← Volver a Procesos</a>
        </nav>
      </div>

      <div class="content">
        <h2>Detalle del Proceso</h2>

        <div class="detalle-proceso">
          <div class="detalle-grid">
            <div><strong>Código:</strong> <span id="codigo"></span></div>
            <div><strong>Tipo de ejecución:</strong> <span id="tipo"></span></div>
            <div><strong>Período:</strong> <span id="periodo"></span></div>
            <div><strong>Inicio:</strong> <span id="inicio"></span></div>
            <div><strong>Fin:</strong> <span id="fin"></span></div>
            <div><strong>Es GDI:</strong> <span id="esgdi"></span></div>
          </div>
          <a id="btnLogs" class="btn-logs">Ver Logs</a>
        </div>

        <div class="filters">
          <input type="text" id="filtroPrestador" placeholder="Prestador" />
          <input type="text" id="filtroBeneficiario" placeholder="Beneficiario" />
          <button onclick="filtrarPracticas()">Actualizar</button>
        </div>

        <div class="tabs">
          <div class="tab active" onclick="showTab('practicas')">Prácticas</div>
          <div class="tab" onclick="showTab('detalle')">Detalle</div>
          <div class="tab" onclick="showTab('cabecera')">Cabecera</div>
          <div class="tab" onclick="showTab('aprob-cabecera')">Aprob Cabecera</div>
        </div>

        <div id="practicas" class="tab-content active"><table id="tablaPracticas" class="styled-table"></table></div>
        <div id="detalle" class="tab-content"><table id="tablaDetalle" class="styled-table"></table></div>
        <div id="cabecera" class="tab-content"><table id="tablaCabecera" class="styled-table"></table></div>
        <div id="aprob-cabecera" class="tab-content"><table id="tablaAprobCabecera" class="styled-table"></table></div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const codigo = params.get("codigo") || "0000";
      const codigoNumerico = parseInt(codigo, 10);
      let practicasGlobal = [],
        detalleGlobal = [],
        cabeceraGlobal = [];

      fetch("../data/procesos.json")
        .then((response) => response.json())
        .then((data) => {
          const proceso = data.results[0].items.find((p) => parseInt(p.c_proceso) === codigoNumerico);
          if (!proceso) return;

          document.getElementById("codigo").textContent = proceso.c_proceso;
          document.getElementById("tipo").textContent = proceso.c_tipo_ejecucion;
          document.getElementById("periodo").textContent = proceso.c_periodo;
          document.getElementById("inicio").textContent = proceso.f_inicio || "-";
          document.getElementById("fin").textContent = proceso.f_fin || "-";
          document.getElementById("esgdi").textContent = proceso.m_es_gdi;
          document.getElementById("btnLogs").href = `logs.html?codigo=${proceso.c_proceso}`;
        });

      Promise.all([
        fetch("../data/practicas.json")
          .then((res) => res.json())
          .then((j) => j.results?.[0]?.items || []),
        fetch("../data/detalle.json")
          .then((res) => res.json())
          .then((j) => j.results?.[0]?.items || []),
        fetch("../data/cabecera.json")
          .then((res) => res.json())
          .then((j) => j.results?.[0]?.items || []),
        fetch("../data/aprob_cabecera.json")
          .then((res) => res.json())
          .then((j) => j.results?.[0]?.items || []),
      ]).then(([practicas, detalle, cabecera, aprobcabecera]) => {
        practicasGlobal = practicas.filter((p) => String(p.c_proceso) === String(codigoNumerico));
        detalleGlobal = detalle.filter((d) => String(d.c_proceso) === String(codigoNumerico));
        cabeceraGlobal = cabecera.filter((c) => String(c.c_proceso) === String(codigoNumerico));
        aprobcabeceraGlobal = aprobcabecera.filter((ac) => String(ac.c_proceso) === String(codigoNumerico));
        renderTable("tablaPracticas", practicasGlobal);
        renderTable("tablaDetalle", detalleGlobal);
        renderTable("tablaCabecera", cabeceraGlobal);
        renderTable("tablaAprobCabecera", aprobcabeceraGlobal);
      });

      function renderTable(id, rows) {
        const table = document.getElementById(id);
        if (!rows || !rows.length) {
          table.innerHTML = "<tr><td colspan='100%'>No hay datos para mostrar</td></tr>";
          return;
        }

        const headers = Object.keys(rows[0]);
        const thead = `<thead><tr>${headers.map((h) => `<th>${h}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${rows
          .map((r) => `<tr>${headers.map((h) => `<td>${r[h]}</td>`).join("")}</tr>`)
          .join("")}</tbody>`;
        table.innerHTML = thead + tbody;
      }

      function showTab(tabId) {
        document.querySelectorAll(".tab").forEach((tab) => tab.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach((tc) => tc.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        document.querySelector(`.tab[onclick=\"showTab('${tabId}')\"]`).classList.add("active");
      }

      function filtrarPracticas() {
        const prestador = document.getElementById("filtroPrestador").value.trim().toLowerCase();
        const beneficiario = document.getElementById("filtroBeneficiario").value.trim().toLowerCase();
        const filtradas = practicasGlobal.filter((p) => {
          const pMatch = prestador === "" || (p.c_prestador && p.c_prestador.toLowerCase().includes(prestador));
          const bMatch = beneficiario === "" || (p.n_beneficio && p.n_beneficio.toLowerCase().includes(beneficiario));
          return pMatch && bMatch;
        });
        renderTable("tablaPracticas", filtradas);
      }
    </script>
  </body>
</html>
